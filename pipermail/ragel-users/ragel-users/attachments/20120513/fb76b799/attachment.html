<tt>
Hello.&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;want&nbsp;to&nbsp;propose&nbsp;yet-another&nbsp;mode&nbsp;for&nbsp;ragel:&nbsp;-GT2.&nbsp;This&nbsp;is&nbsp;goto-driven&nbsp;fsm&nbsp;which&nbsp;sometimes&nbsp;uses&nbsp;tables.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;A&nbsp;bit&nbsp;of&nbsp;background.&nbsp;We&#39;ve&nbsp;tried&nbsp;to&nbsp;use&nbsp;ragel&nbsp;to&nbsp;process&nbsp;x86&nbsp;instructions&nbsp;stream.&nbsp;This&nbsp;produces&nbsp;large&nbsp;FSM&nbsp;(about&nbsp;thousand&nbsp;states&nbsp;and&nbsp;similar&nbsp;number&nbsp;of&nbsp;actions)&nbsp;which&nbsp;works&nbsp;fine&nbsp;with&nbsp;GCC,&nbsp;but&nbsp;which&nbsp;works&nbsp;much&nbsp;less&nbsp;fine&nbsp;with&nbsp;MSVC.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Initially&nbsp;we&#39;ve&nbsp;used&nbsp;MSVC&nbsp;2008&nbsp;and&nbsp;the&nbsp;main&nbsp;problem&nbsp;was&nbsp;slow&nbsp;compilation&nbsp;(where&nbsp;GCC&nbsp;required&nbsp;about&nbsp;minute&nbsp;to&nbsp;compile&nbsp;the&nbsp;G2-mode&nbsp;FSM&nbsp;with&nbsp;full&nbsp;optimization&nbsp;MSVC&nbsp;took&nbsp;half-hour&nbsp;to&nbsp;hour&nbsp;depending&nbsp;on&nbsp;what&nbsp;exactly&nbsp;we&#39;ve&nbsp;tried&nbsp;to&nbsp;do&nbsp;with&nbsp;a&nbsp;stream)&nbsp;and&nbsp;slow&nbsp;execution&nbsp;(code&nbsp;produced&nbsp;by&nbsp;MSVC&nbsp;2008&nbsp;was&nbsp;about&nbsp;45%&nbsp;slower&nbsp;then&nbsp;code&nbsp;produced&nbsp;by&nbsp;GCC).&nbsp;But&nbsp;when&nbsp;we&#39;ve&nbsp;tried&nbsp;to&nbsp;switch&nbsp;to&nbsp;MSVC&nbsp;2010&nbsp;we&#39;ve&nbsp;hit&nbsp;worse problem:&nbsp;now&nbsp;compilation&nbsp;is&nbsp;instant&nbsp;(about&nbsp;4-5&nbsp;seconds),&nbsp;but&nbsp;execution&nbsp;speed&nbsp;is&nbsp;awful&nbsp;(almost&nbsp;three&nbsp;times&nbsp;slower&nbsp;then&nbsp;what&nbsp;GCC&nbsp;is&nbsp;producing).&nbsp;Looks&nbsp;like&nbsp;MSVC&nbsp;2010&nbsp;stops&nbsp;optimization&nbsp;attempts&nbsp;if&nbsp;it&nbsp;sees&nbsp;too&nbsp;many&nbsp;basic&nbsp;blocks&nbsp;and&nbsp;gotos.&nbsp;We&#39;ve&nbsp;played&nbsp;a&nbsp;bit&nbsp;with&nbsp;different&nbsp;options&nbsp;and&nbsp;they&nbsp;all&nbsp;produce&nbsp;much&nbsp;slower&nbsp;code.&nbsp;Thus&nbsp;we&#39;ve&nbsp;tried&nbsp;to&nbsp;take&nbsp;-G2&nbsp;mode&nbsp;and&nbsp;&quot;fix&nbsp;it&quot;:&nbsp;if&nbsp;the&nbsp;state&nbsp;has&nbsp;too&nbsp;many&nbsp;different&nbsp;transitions&nbsp;then&nbsp;we&nbsp;are&nbsp;using&nbsp;cs-dispatch&nbsp;table&nbsp;and&nbsp;_again&nbsp;switch.&nbsp;This&nbsp;produces&nbsp;version&nbsp;which&nbsp;is&nbsp;slower&nbsp;by&nbsp;about&nbsp;20%&nbsp;on&nbsp;GCC&nbsp;but&nbsp;is&nbsp;faster&nbsp;then&nbsp;what&nbsp;MSVC&nbsp;2008&nbsp;produced&nbsp;by&nbsp;about&nbsp;the&nbsp;same&nbsp;20%&nbsp;(MSVC&nbsp;2008,&nbsp;MSVC&nbsp;2010&nbsp;and&nbsp;GCC&nbsp;have&nbsp;about&nbsp;the&nbsp;same&nbsp;speed&nbsp;in&nbsp;this&nbsp;case).&nbsp;And&nbsp;the&nbsp;compilation&nbsp;now&nbsp;takes&nbsp;2-3&nbsp;minutes&nbsp;instead&nbsp;of&nbsp;hour.&nbsp;What&nbsp;do&nbsp;you&nbsp;think&nbsp;about&nbsp;it?&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Patch&nbsp;is&nbsp;attached.&nbsp;Note:&nbsp;the&nbsp;threshold&nbsp;(32&nbsp;comparisons)&nbsp;is&nbsp;picked&nbsp;to&nbsp;make&nbsp;-G2&nbsp;and&nbsp;-GT2&nbsp;FSMs&nbsp;similar&nbsp;in&nbsp;size.&nbsp;On&nbsp;x86&nbsp;comparison&nbsp;takes&nbsp;three&nbsp;bytes,&nbsp;jump&nbsp;takes&nbsp;six&nbsp;bytes,&nbsp;but&nbsp;you&nbsp;need&nbsp;about&nbsp;1.5-2&nbsp;times&nbsp;as&nbsp;much&nbsp;comparisons&nbsp;as&nbsp;you&nbsp;have&nbsp;final&nbsp;outcomes&nbsp;to&nbsp;guarantee&nbsp;there&nbsp;are&nbsp;O(log&nbsp;k)&nbsp;compleity,&nbsp;not&nbsp;O(k)&nbsp;complexity&nbsp;(compiler&nbsp;ensures&nbsp;this...&nbsp;if&nbsp;number&nbsp;of&nbsp;basic&nbsp;blocks&nbsp;as&nbsp;reasonable,&nbsp;that&nbsp;is).&nbsp;The&nbsp;exact&nbsp;number&nbsp;varies&nbsp;depending&nbsp;on&nbsp;options&nbsp;of&nbsp;the&nbsp;compiler&nbsp;and&nbsp;the&nbsp;exact&nbsp;nature&nbsp;of&nbsp;FSM&nbsp;and&nbsp;usually&nbsp;lies&nbsp;between&nbsp;30&nbsp;and&nbsp;35&nbsp;thus&nbsp;32&nbsp;looks&nbsp;like&nbsp;good&nbsp;round&nbsp;number&nbsp;(minor&nbsp;variations&nbsp;produce&nbsp;tiny&nbsp;changes&nbsp;in&nbsp;speed&nbsp;and&nbsp;size&nbsp;as&nbsp;you&nbsp;can&nbsp;guess).&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;P.S.&nbsp;Patch&nbsp;must&nbsp;probably&nbsp;be&nbsp;cleaned&nbsp;up&nbsp;a&nbsp;bit,&nbsp;but&nbsp;I&nbsp;wanted&nbsp;to&nbsp;discuss&nbsp;the&nbsp;feasibility&nbsp;of&nbsp;said&nbsp;mode&nbsp;first.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
