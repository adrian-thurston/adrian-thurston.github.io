<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [ragel-users] MSVC-friendly -GT2 mode
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:ragel-users%40colm.net?Subject=Re%3A%20%5Bragel-users%5D%20MSVC-friendly%20-GT2%20mode&In-Reply-To=%3C2107313512-1337019633-cardhu_decombobulator_blackberry.rim.net-211485438-%40b17.c7.bise6.blackberry%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="003306.html">
   <LINK REL="Next"  HREF="003308.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[ragel-users] MSVC-friendly -GT2 mode</H1>
    <B>Adrian Thurston</B> 
    <A HREF="mailto:ragel-users%40colm.net?Subject=Re%3A%20%5Bragel-users%5D%20MSVC-friendly%20-GT2%20mode&In-Reply-To=%3C2107313512-1337019633-cardhu_decombobulator_blackberry.rim.net-211485438-%40b17.c7.bise6.blackberry%3E"
       TITLE="[ragel-users] MSVC-friendly -GT2 mode">thurston at complang.org
       </A><BR>
    <I>Mon May 14 18:20:35 UTC 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="003306.html">[ragel-users] MSVC-friendly -GT2 mode
</A></li>
        <LI>Next message: <A HREF="003308.html">[ragel-users] [PATCH] aapl: fix building with gcc-4.7.0
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3307">[ date ]</a>
              <a href="thread.html#3307">[ thread ]</a>
              <a href="subject.html#3307">[ subject ]</a>
              <a href="author.html#3307">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I like it, thank you for submitting it. Can it wait for ragel 7.0? I can't really say when that will be done. If not it can go into a 6.8 (along with other patches that are waiting). 

Adrian
-----Original Message-----
From: Victor Khimenko &lt;<A HREF="http://www.colm.net/cgi-bin/mailman/listinfo/ragel-users">khim at chromium.org</A>&gt;
Sender: <A HREF="http://www.colm.net/cgi-bin/mailman/listinfo/ragel-users">khim at google.com</A>
Date: Mon, 14 May 2012 21:50:01 
To: &lt;<A HREF="http://www.colm.net/cgi-bin/mailman/listinfo/ragel-users">thurston at complang.org</A>&gt;; &lt;<A HREF="http://www.colm.net/cgi-bin/mailman/listinfo/ragel-users">ragel-users at complang.org</A>&gt;
Subject: Re: [ragel-users] MSVC-friendly -GT2 mode

Example of the change in -GT2 mode.

Instead of this:

st47:
if ( ++p == pe )
goto _test_eof47;
case 47:
switch( (*p) ) {
case 4u: goto tr118;
case 5u: goto tr119;
case 12u: goto tr118;
case 13u: goto tr119;
case 20u: goto tr118;
case 21u: goto tr119;
case 28u: goto tr118;
case 29u: goto tr119;
case 36u: goto tr118;
case 37u: goto tr119;
case 44u: goto tr118;
case 45u: goto tr119;
case 52u: goto tr118;
case 53u: goto tr119;
case 60u: goto tr118;
case 61u: goto tr119;
case 68u: goto tr121;
case 76u: goto tr121;
case 84u: goto tr121;
case 92u: goto tr121;
case 100u: goto tr121;
case 108u: goto tr121;
case 116u: goto tr121;
case 124u: goto tr121;
case 132u: goto tr123;
case 140u: goto tr123;
case 148u: goto tr123;
case 156u: goto tr123;
case 164u: goto tr123;
case 172u: goto tr123;
case 180u: goto tr123;
case 188u: goto tr123;
}
if ( (*p) &lt; 64u ) {
if ( (*p) &lt;= 63u )
goto tr117;
} else if ( (*p) &gt; 127u ) {
if ( 128u &lt;= (*p) &amp;&amp; (*p) &lt;= 191u )
goto tr122;
} else
goto tr120;
goto tr124;

We have this:

st47:
if ( ++p == pe )
goto _test_eof47;
case 47:
{
static const unsigned char jump_table[] = { 0, 0, 0, 0, 1, 2, 0, 0, 0, 0,
0, 0, 1, 2, 0, 0, 0, 0, 0, 0, 1, 2, 0, 0, 0, 0, 0, 0, 1, 2, 0, 0, 0, 0, 0,
0, 1, 2, 0, 0, 0, 0, 0, 0, 1, 2, 0, 0, 0, 0, 0, 0, 1, 2, 0, 0, 0, 0, 0, 0,
1, 2, 0, 0, 3, 3, 3, 3, 4, 3, 3, 3, 3, 3, 3, 3, 4, 3, 3, 3, 3, 3, 3, 3, 4,
3, 3, 3, 3, 3, 3, 3, 4, 3, 3, 3, 3, 3, 3, 3, 4, 3, 3, 3, 3, 3, 3, 3, 4, 3,
3, 3, 3, 3, 3, 3, 4, 3, 3, 3, 3, 3, 3, 3, 4, 3, 3, 3, 5, 5, 5, 5, 6, 5, 5,
5, 5, 5, 5, 5, 6, 5, 5, 5, 5, 5, 5, 5, 6, 5, 5, 5, 5, 5, 5, 5, 6, 5, 5, 5,
5, 5, 5, 5, 6, 5, 5, 5, 5, 5, 5, 5, 6, 5, 5, 5, 5, 5, 5, 5, 6, 5, 5, 5, 5,
5, 5, 5, 6, 5, 5, 5, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7 };
cs = jump_table[(*p)] + 933;
goto _again;
}

And this is basically all. Very small, very local change to -G2 mode which,
as I've explained above, makes a world of difference in our case. If you
replace ALL cases with jump tables then speed really suffers and size of
the result grows significantly, if you only do this for cases with large
number of outcomes then size actually shrinks and speed drop is moderate
(negative in case of MSVC because we obviously hit some limits of the
beast) since original code needs to do quite a large number of comparisons
(or may be use some table behind the scene) anyway.

P.S. And is it possible to somehow really remove line numbers from the
generated output? They are removed for all languages except C with -L flag,
but for C they are just commented out. This increases size of generated
file by about 10% needlessly :-( We can just filter them out, of course,
but for all other languages you don't need this. Perhaps second -L can
actually remove line numbers?

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://www.colm.net/pipermail/ragel-users/attachments/20120514/054f6e2c/attachment-0001.html">http://www.colm.net/pipermail/ragel-users/attachments/20120514/054f6e2c/attachment-0001.html</A>&gt;
-------------- next part --------------
_______________________________________________
ragel-users mailing list
<A HREF="http://www.colm.net/cgi-bin/mailman/listinfo/ragel-users">ragel-users at complang.org</A>
<A HREF="http://www.complang.org/mailman/listinfo/ragel-users">http://www.complang.org/mailman/listinfo/ragel-users</A>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003306.html">[ragel-users] MSVC-friendly -GT2 mode
</A></li>
	<LI>Next message: <A HREF="003308.html">[ragel-users] [PATCH] aapl: fix building with gcc-4.7.0
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3307">[ date ]</a>
              <a href="thread.html#3307">[ thread ]</a>
              <a href="subject.html#3307">[ subject ]</a>
              <a href="author.html#3307">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://www.colm.net/cgi-bin/mailman/listinfo/ragel-users">More information about the ragel-users
mailing list</a><br>
</body></html>
