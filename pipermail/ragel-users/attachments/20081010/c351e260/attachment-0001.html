<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hello&nbsp;all&nbsp;-&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;br&gt;Having&nbsp;a&nbsp;bit&nbsp;of&nbsp;trouble&nbsp;with&nbsp;fcall/fret.&lt;br&gt;&lt;br&gt;I&nbsp;need&nbsp;to&nbsp;read&nbsp;a&nbsp;number&nbsp;in&nbsp;a&nbsp;string&nbsp;that&nbsp;indicates&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;to&nbsp;follow.&nbsp;I&nbsp;do&nbsp;this&nbsp;correctly&nbsp;with&nbsp;a&nbsp;complete&nbsp;string,&nbsp;but&nbsp;also&nbsp;reach&nbsp;a&nbsp;final&nbsp;state&nbsp;with&nbsp;an&nbsp;incomplete&nbsp;string&nbsp;that&nbsp;includes&nbsp;some&nbsp;of&nbsp;the&nbsp;binary&nbsp;data.&nbsp;I&#39;m&nbsp;using&nbsp;fcall&nbsp;into&nbsp;another&nbsp;&lt;span&nbsp;style=&quot;padding:&nbsp;0pt;&nbsp;background-color:&nbsp;yellow;&nbsp;color:&nbsp;black;&nbsp;display:&nbsp;inline;&nbsp;font-size:&nbsp;inherit;&quot;&gt;machine&lt;/span&gt;&nbsp;to&nbsp;read&nbsp;the&nbsp;binary&nbsp;data.&lt;br&gt;<br>
<br>
&lt;br&gt;Have&nbsp;I&nbsp;missed&nbsp;something&nbsp;obvious?&lt;br&gt;&lt;br&gt;Thanks,&lt;br&gt;Gordon&lt;br&gt;&lt;br&gt;%%{&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;span&nbsp;style=&quot;padding:&nbsp;0pt;&nbsp;background-color:&nbsp;yellow;&nbsp;color:&nbsp;black;&nbsp;display:&nbsp;inline;&nbsp;font-size:&nbsp;inherit;&quot;&gt;machine&lt;/span&gt;&nbsp;TEST;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;alphtype&nbsp;char;&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;action&nbsp;binary_data_&lt;span&nbsp;style=&quot;padding:&nbsp;0pt;&nbsp;background-color:&nbsp;yellow;&nbsp;color:&nbsp;black;&nbsp;display:&nbsp;inline;&nbsp;font-size:&nbsp;inherit;&quot;&gt;length&lt;/span&gt;_check&nbsp;{&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fsm.binary_data_count++;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;fsm.binary_data_count&nbsp;&gt;=&nbsp;fsm.byte_count&nbsp;)&nbsp;{&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//fhold;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fret;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;action&nbsp;binary_data_init&nbsp;{&nbsp;fsm.binary_data_count&nbsp;=&nbsp;0;&nbsp;}&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;binary_data_&lt;span&nbsp;style=&quot;padding:&nbsp;0pt;&nbsp;background-color:&nbsp;yellow;&nbsp;color:&nbsp;black;&nbsp;display:&nbsp;inline;&nbsp;font-size:&nbsp;inherit;&quot;&gt;machine&lt;/span&gt;&nbsp;:=&nbsp;any+&nbsp;$binary_data_&lt;span&nbsp;style=&quot;padding:&nbsp;0pt;&nbsp;background-color:&nbsp;yellow;&nbsp;color:&nbsp;black;&nbsp;display:&nbsp;inline;&nbsp;font-size:&nbsp;inherit;&quot;&gt;length&lt;/span&gt;_check&nbsp;&gt;binary_data_init;&lt;br&gt;<br>
<br>
&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;We&#39;re&nbsp;trying&nbsp;to&nbsp;do&nbsp;this:&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;any{fsm.byte_count}&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;action&nbsp;binary_data_action&nbsp;{&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fcall&nbsp;binary_data_&lt;span&nbsp;style=&quot;padding:&nbsp;0pt;&nbsp;background-color:&nbsp;yellow;&nbsp;color:&nbsp;black;&nbsp;display:&nbsp;inline;&nbsp;font-size:&nbsp;inherit;&quot;&gt;machine&lt;/span&gt;;&lt;br&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;binary_payload&nbsp;=&nbsp;&#39;r.&#39;&nbsp;@binary_data_action;&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;b:&lt;NumBytes&gt;:&lt;NumBytes&nbsp;of&nbsp;chars&gt;:&lt;CRC&gt;&lt;CR&gt;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;bridge_packet&nbsp;=&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;b:&#39;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(&nbsp;xdigit&nbsp;@{&nbsp;AddXDigit(&nbsp;fsm.byte_count,&nbsp;*&nbsp;p&nbsp;);&nbsp;}&nbsp;)+&lt;br&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;:&#39;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;binary_payload&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;:&#39;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xdigit+&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;\r&#39;;&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;main&nbsp;:=&nbsp;bridge_packet;&lt;br&gt;}%%&lt;br&gt;&lt;br&gt;%%&nbsp;write&nbsp;data;&lt;br&gt;&lt;br&gt;void&nbsp;init()&nbsp;{&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;%%&nbsp;write&nbsp;init;&lt;br&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;fsm.byte_count&nbsp;=&nbsp;0;&lt;br&gt;}&lt;br&gt;&lt;br&gt;void&nbsp;parse(char&nbsp;*&nbsp;payload,&nbsp;char&nbsp;*&nbsp;payloadEnd)&nbsp;{&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;char&nbsp;*&nbsp;p&nbsp;=&nbsp;payload;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;char&nbsp;*&nbsp;pe&nbsp;=&nbsp;payloadEnd;&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;%%&nbsp;access&nbsp;fsm.;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;%%&nbsp;write&nbsp;exec;&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;fsm.cs&nbsp;==&nbsp;TEST_error&nbsp;)&nbsp;{&lt;br&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;std::cout&nbsp;&lt;&lt;&nbsp;&quot;FINISH_ERROR\n&quot;;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(&nbsp;fsm.cs&nbsp;&gt;=&nbsp;TEST_first_final&nbsp;)&nbsp;{&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;std::cout&nbsp;&lt;&lt;&nbsp;&quot;FINISH_FINAL\n&quot;;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;std::cout&nbsp;&lt;&lt;&nbsp;&quot;FINISH_NOT_FINAL\n&quot;;&lt;br&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br&gt;}&lt;br&gt;&lt;br&gt;int&nbsp;main()&nbsp;{&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;init();&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;{&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Complete&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;char&nbsp;*&nbsp;t1&nbsp;=&nbsp;&quot;b:0004:r.abcd:a0\r&quot;;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parse(t1,&nbsp;t1&nbsp;+&nbsp;strlen(&nbsp;t1&nbsp;)&nbsp;);&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;init();&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;{&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Incomplete&lt;br&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;char&nbsp;*&nbsp;t1&nbsp;=&nbsp;&quot;b:0004:r.ab&quot;;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parse(t1,&nbsp;t1&nbsp;+&nbsp;strlen(&nbsp;t1&nbsp;)&nbsp;);&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;&lt;br&gt;}&lt;br&gt;&lt;br&gt;----------&lt;br&gt;Output&nbsp;is:&lt;br&gt;{{{&lt;br&gt;FINISH_FINAL&lt;br&gt;FINISH_FINAL&lt;br&gt;}}}&lt;br&gt;&lt;br&gt;and&nbsp;I&nbsp;expect&lt;br&gt;<br>
<br>
{{{&lt;br&gt;FINISH_FINAL&lt;br&gt;<br>
FINISH_NOT_FINAL&lt;br&gt;<br>
}}}&lt;br&gt;&lt;br&gt;AddXDigit(&nbsp;unsigned&nbsp;target,&nbsp;char&nbsp;c&nbsp;)&nbsp;adds&nbsp;value&nbsp;of&nbsp;hexadecimal&nbsp;digit&nbsp;to&nbsp;target.&lt;br&gt;&lt;br&gt;&lt;/div&gt;<br>
&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
