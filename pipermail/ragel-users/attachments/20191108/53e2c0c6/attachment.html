<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;gmail_signature&quot;&nbsp;data-smartmail=&quot;gmail_signature&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;I&nbsp;have&nbsp;a&nbsp;ragel&nbsp;machine&nbsp;that&nbsp;generates&nbsp;passing&nbsp;Go&nbsp;code&nbsp;when&nbsp;built&nbsp;with&nbsp;-G1,&nbsp;but&nbsp;failing&nbsp;code&nbsp;when&nbsp;built&nbsp;with&nbsp;-G2&nbsp;(using&nbsp;ragel&nbsp;6.10&nbsp;on&nbsp;ubuntu).&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Given&nbsp;the&nbsp;following&nbsp;machine&nbsp;definition:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;-------------------------------------------------------------------------&lt;/div&gt;&lt;div&gt;package&nbsp;safe16l&lt;br&gt;&lt;br&gt;import&nbsp;(&lt;br&gt; &nbsp; &nbsp;&quot;fmt&quot;&lt;br&gt;)&lt;br&gt;&lt;br&gt;%%{&lt;br&gt; &nbsp; &nbsp;machine&nbsp;safe16;&lt;br&gt; &nbsp; &nbsp;access&nbsp;this.;&lt;br&gt;&lt;br&gt; &nbsp; &nbsp;numeric_hi&nbsp;=&nbsp;[0-9]&nbsp;@{&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;accumulator&nbsp;=&nbsp;(fc&nbsp;-&nbsp;&#39;0&#39;)&nbsp;&lt;&lt;&nbsp;4&lt;br&gt; &nbsp; &nbsp;};&lt;br&gt; &nbsp; &nbsp;af_hi&nbsp;=&nbsp;[a-f]&nbsp;@{&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;accumulator&nbsp;=&nbsp;(fc&nbsp;-&nbsp;&#39;a&#39;&nbsp;+&nbsp;10)&nbsp;&lt;&lt;&nbsp;4&lt;br&gt; &nbsp; &nbsp;};&lt;br&gt; &nbsp; &nbsp;AF_hi&nbsp;=&nbsp;[A-F]&nbsp;@{&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;accumulator&nbsp;=&nbsp;(fc&nbsp;-&nbsp;&#39;A&#39;&nbsp;+&nbsp;10)&nbsp;&lt;&lt;&nbsp;4&lt;br&gt; &nbsp; &nbsp;};&lt;br&gt; &nbsp; &nbsp;numeric_lo&nbsp;=&nbsp;[0-9]&nbsp;@{&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;accumulator&nbsp;|=&nbsp;fc&nbsp;-&nbsp;&#39;0&#39;&lt;br&gt; &nbsp; &nbsp;};&lt;br&gt; &nbsp; &nbsp;af_lo&nbsp;=&nbsp;[a-f]&nbsp;@{&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;accumulator&nbsp;|=&nbsp;fc&nbsp;-&nbsp;&#39;a&#39;&nbsp;+&nbsp;10&lt;br&gt; &nbsp; &nbsp;};&lt;br&gt; &nbsp; &nbsp;AF_lo&nbsp;=&nbsp;[A-F]&nbsp;@{&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;accumulator&nbsp;|=&nbsp;fc&nbsp;-&nbsp;&#39;A&#39;&nbsp;+&nbsp;10&lt;br&gt; &nbsp; &nbsp;};&lt;br&gt;&lt;br&gt; &nbsp; &nbsp;sequence&nbsp;=&nbsp;space*&nbsp;(numeric_hi&nbsp;|&nbsp;af_hi&nbsp;|&nbsp;AF_hi)&nbsp;space*&nbsp;(numeric_lo&nbsp;|&nbsp;af_lo&nbsp;|&nbsp;AF_lo)&nbsp;%{&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;dst[dstIndex]&nbsp;=&nbsp;accumulator&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;dstIndex++&lt;br&gt; &nbsp; &nbsp;};&lt;br&gt;&lt;br&gt;&lt;br&gt; &nbsp; &nbsp;length_nocontinue&nbsp;=&nbsp;[0-7]&nbsp;@{&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;this.length&nbsp;=&nbsp;this.length&nbsp;&lt;&lt;&nbsp;3&nbsp;+&nbsp;int(fc&nbsp;-&nbsp;&#39;0&#39;)&lt;br&gt; &nbsp; &nbsp;};&lt;br&gt; &nbsp; &nbsp;length_numeric&nbsp;=&nbsp;[8-9]&nbsp;@{&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;this.length&nbsp;=&nbsp;this.length&nbsp;&lt;&lt;&nbsp;3&nbsp;+&nbsp;int(fc&nbsp;-&nbsp;&#39;0&#39;)&lt;br&gt; &nbsp; &nbsp;};&lt;br&gt; &nbsp; &nbsp;length_af&nbsp;=&nbsp;[a-f]&nbsp;@{&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;this.length&nbsp;=&nbsp;this.length&nbsp;&lt;&lt;&nbsp;3&nbsp;+&nbsp;int(fc&nbsp;-&nbsp;&#39;a&#39;&nbsp;+&nbsp;10&nbsp;-&nbsp;8)&lt;br&gt; &nbsp; &nbsp;};&lt;br&gt; &nbsp; &nbsp;length_AF&nbsp;=&nbsp;[A-F]&nbsp;@{&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;this.length&nbsp;=&nbsp;this.length&nbsp;&lt;&lt;&nbsp;3&nbsp;+&nbsp;int(fc&nbsp;-&nbsp;&#39;A&#39;&nbsp;+&nbsp;10&nbsp;-&nbsp;8)&lt;br&gt; &nbsp; &nbsp;};&lt;br&gt;&lt;br&gt; &nbsp; &nbsp;length&nbsp;=&nbsp;(length_numeric&nbsp;|&nbsp;length_af&nbsp;|&nbsp;length_AF)*&nbsp;length_nocontinue;&lt;br&gt;&lt;br&gt; &nbsp; &nbsp;sequence_counted&nbsp;=&nbsp;sequence&nbsp;%{&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;fmt.Printf(&quot;###&nbsp;End&nbsp;of&nbsp;sequence\n&quot;)&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;this.length--&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;if&nbsp;this.length&nbsp;==&nbsp;0&nbsp;{&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;this.isComplete&nbsp;=&nbsp;true&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;fbreak;&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;}&lt;br&gt; &nbsp; &nbsp;};&lt;br&gt;&lt;br&gt; &nbsp; &nbsp;main&nbsp;:=&nbsp;length&nbsp;sequence_counted*&nbsp;@/{&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;err&nbsp;=&nbsp;fmt.Errorf(&quot;Incomplete&nbsp;document&quot;)&lt;br&gt; &nbsp; &nbsp;};&lt;br&gt;}%%&lt;br&gt;&lt;br&gt;&lt;br&gt;%%&nbsp;write&nbsp;data;&lt;br&gt;&lt;br&gt;type&nbsp;Parser&nbsp;struct&nbsp;{&lt;br&gt; &nbsp; &nbsp;cs&nbsp;int&nbsp;//&nbsp;Current&nbsp;Ragel&nbsp;state&lt;br&gt; &nbsp; &nbsp;data&nbsp;[]byte&lt;br&gt; &nbsp; &nbsp;length&nbsp;int&lt;br&gt; &nbsp; &nbsp;isComplete&nbsp;bool&lt;br&gt;}&lt;br&gt;&lt;br&gt;func&nbsp;(this&nbsp;*Parser)&nbsp;Init()&nbsp;{&lt;br&gt;}&lt;br&gt;&lt;br&gt;func&nbsp;NewParser()&nbsp;*Parser&nbsp;{&lt;br&gt; &nbsp; &nbsp;this&nbsp;:=&nbsp;new(Parser)&lt;br&gt; &nbsp; &nbsp;return&nbsp;this&lt;br&gt;}&lt;br&gt;&lt;br&gt;func&nbsp;(this&nbsp;*Parser)&nbsp;Parse(src&nbsp;[]byte,&nbsp;dst&nbsp;[]byte)&nbsp;(bytesWritten&nbsp;int,&nbsp;isComplete&nbsp;bool,&nbsp;err&nbsp;error)&nbsp;{&lt;br&gt; &nbsp; &nbsp;this.data&nbsp;=&nbsp;src&lt;br&gt; &nbsp; &nbsp;p&nbsp;:=&nbsp;0&nbsp;//&nbsp;Position:&nbsp;current&lt;br&gt; &nbsp; &nbsp;pe&nbsp;:=&nbsp;len(this.data)&nbsp;//&nbsp;Position:&nbsp;end&nbsp;of&nbsp;buffer&lt;br&gt; &nbsp; &nbsp;//&nbsp;TODO:&nbsp;Change&nbsp;to&nbsp;-1&nbsp;and&nbsp;check&nbsp;for&nbsp;end&nbsp;of&nbsp;file&lt;br&gt; &nbsp; &nbsp;eof&nbsp;:=&nbsp;pe&nbsp;//&nbsp;Position:&nbsp;end&nbsp;of&nbsp;file&lt;br&gt; &nbsp; &nbsp;accumulator&nbsp;:=&nbsp;byte(0)&lt;br&gt; &nbsp; &nbsp;dstIndex&nbsp;:=&nbsp;0&lt;br&gt;&lt;br&gt; &nbsp; &nbsp;_&nbsp;=&nbsp;eof&lt;br&gt; &nbsp; &nbsp;&lt;br&gt; &nbsp; &nbsp;%%{&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;write&nbsp;init;&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;write&nbsp;exec;&lt;br&gt; &nbsp; &nbsp;}%%&lt;br&gt;&lt;br&gt; &nbsp; &nbsp;if&nbsp;this.cs&nbsp;==&nbsp;safe16_error&nbsp;{&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;err&nbsp;=&nbsp;fmt.Errorf(&quot;Parse&nbsp;error&nbsp;at&nbsp;%v&quot;,&nbsp;p)&lt;br&gt; &nbsp; &nbsp;}&lt;br&gt;&lt;br&gt; &nbsp; &nbsp;return&nbsp;dstIndex,&nbsp;this.isComplete,&nbsp;err&lt;br&gt;}&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;-------------------------------------------------------------------------&lt;/div&gt;&lt;div&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;And&nbsp;the&nbsp;following&nbsp;test&nbsp;code:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;-------------------------------------------------------------------------&lt;/div&gt;&lt;div&gt;&lt;/div&gt;&lt;div&gt;package&nbsp;safe16l&lt;br&gt;&lt;br&gt;import&nbsp;(&lt;br&gt; &nbsp; &nbsp;&quot;bytes&quot;&lt;br&gt; &nbsp; &nbsp;&quot;testing&quot;&lt;br&gt;)&lt;br&gt;&lt;br&gt;func&nbsp;testSafe16L(t&nbsp;*testing.T,&nbsp;src&nbsp;string,&nbsp;expected&nbsp;[]byte)&nbsp;{&lt;br&gt; &nbsp; &nbsp;dst&nbsp;:=&nbsp;make([]byte,&nbsp;len(src))&lt;br&gt; &nbsp; &nbsp;parser&nbsp;:=&nbsp;NewParser()&lt;br&gt;&lt;br&gt; &nbsp; &nbsp;bytesWritten,&nbsp;isComplete,&nbsp;err&nbsp;:=&nbsp;parser.Parse([]byte(src),&nbsp;dst)&lt;br&gt; &nbsp; &nbsp;if&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;t.Error(err)&lt;br&gt; &nbsp; &nbsp;}&lt;br&gt; &nbsp; &nbsp;if&nbsp;!isComplete&nbsp;{&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;t.Errorf(&quot;Sequence&nbsp;[%v]:&nbsp;Incomplete&nbsp;parse&quot;,&nbsp;src)&lt;br&gt; &nbsp; &nbsp;}&lt;br&gt;&lt;br&gt; &nbsp; &nbsp;actual&nbsp;:=&nbsp;dst[:bytesWritten]&lt;br&gt; &nbsp; &nbsp;if&nbsp;!bytes.Equal(actual,&nbsp;expected)&nbsp;{&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;t.Errorf(&quot;Sequence&nbsp;[%v]:&nbsp;Expected&nbsp;%v&nbsp;but&nbsp;got&nbsp;%v&quot;,&nbsp;src,&nbsp;expected,&nbsp;actual)&lt;br&gt; &nbsp; &nbsp;}&lt;br&gt;}&lt;br&gt;&lt;br&gt;func&nbsp;TestSafe16L(t&nbsp;*testing.T)&nbsp;{&lt;br&gt; &nbsp; &nbsp;testSafe16L(t,&nbsp;&quot;100&quot;,&nbsp;[]byte{0x00})&lt;br&gt;}&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;-------------------------------------------------------------------------&lt;/div&gt;&lt;div&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;With&nbsp;G1:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;$&nbsp;ragel&nbsp;-Z&nbsp;-G1&nbsp;safe16l.rl&nbsp;&amp;&amp;&nbsp;go&nbsp;test&lt;br&gt;###&nbsp;End&nbsp;of&nbsp;sequence&lt;br&gt;PASS&lt;br&gt;ok&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;http://github.com/kstenerud/go-safe16&quot;&gt;github.com/kstenerud/go-safe16&lt;/a&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.001s&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;With&nbsp;G2:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;$&nbsp;ragel&nbsp;-Z&nbsp;-G2&nbsp;safe16l.rl&nbsp;&amp;&amp;&nbsp;go&nbsp;test&lt;br&gt;###&nbsp;End&nbsp;of&nbsp;sequence&lt;br&gt;---&nbsp;FAIL:&nbsp;TestSafe16L&nbsp;(0.00s)&lt;br&gt; &nbsp; &nbsp;parser_test.go:14:&nbsp;Parse&nbsp;error&nbsp;at&nbsp;4&lt;br&gt;FAIL&lt;br&gt;exit&nbsp;status&nbsp;1&lt;br&gt;FAIL&nbsp;&nbsp;&lt;a&nbsp;href=&quot;http://github.com/kstenerud/go-safe16&quot;&gt;github.com/kstenerud/go-safe16&lt;/a&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.001s&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;-------------------------------------------------------------------------&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Looking&nbsp;at&nbsp;the&nbsp;generated&nbsp;code,&nbsp;I&nbsp;see&nbsp;this&nbsp;in&nbsp;the&nbsp;-G2&nbsp;version:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;//line&nbsp;safe16l.rl:51&lt;br&gt;&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;fmt.Printf(&quot;###&nbsp;End&nbsp;of&nbsp;sequence\n&quot;)&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;this.length--&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;if&nbsp;this.length&nbsp;==&nbsp;0&nbsp;{&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;this.isComplete&nbsp;=&nbsp;true&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{p++;&nbsp; this.cs&nbsp;=&nbsp;0;&nbsp;goto&nbsp;_out&nbsp;}&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&#39;m&nbsp;not&nbsp;sure&nbsp;why&nbsp;cs&nbsp;would&nbsp;be&nbsp;set&nbsp;to&nbsp;0&nbsp;here.&nbsp;This&nbsp;isn&#39;t&nbsp;an&nbsp;error&nbsp;state&nbsp;as&nbsp;far&nbsp;as&nbsp;I&nbsp;can&nbsp;tell...&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Cheers,&lt;/div&gt;&lt;div&gt;Karl&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
